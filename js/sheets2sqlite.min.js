var Sheets2sqlite=function(e,t,n){this.db=e,this.tablesToProcess=n,this.tables=[],this.control={reqs:0,reqOk:!1,resps:0,ok:function(){return this.reqOk&&this.reqs==this.resps},reset:function(){this.reqs=0,this.resps=0,this.reqOk=!1}},this.url="//spreadsheets.google.com/feeds/worksheets/"+t+"/public/values?alt=json"};Sheets2sqlite.prototype.start=function(e){this.done=e;var t=this;$.ajax({url:this.url}).done(function(e){for(var n=0;n<e.feed.entry.length;n++){var r=e.feed.entry[n],s={name:r.title.$t,link:r.link[1].href.replace("https:","")+"?alt=json"};t.control.reqs++,function(e,n){$.ajax({url:n}).done(function(n){t.processWorksheetData(e,n)})}(s.name,s.link)}t.control.reqOk=!0})},Sheets2sqlite.prototype.processWorksheetData=function(e,t){if(this.control.resps++,$.inArray(e,this.tablesToProcess)>=0){var n=this.createTable(e,t);this.insertData(n,t),this.tables.push(n)}this.control.ok()&&(this.loadData(this.tables),this.done(),this.control.reset())},Sheets2sqlite.prototype.createTable=function(e,t){for(var n=[],r={name:e,fkCount:!1,regularIndexes:[],uniqueIndexes:[],createSQL:function(){for(var e="CREATE TABLE "+this.name+" (",t=0;t<this.columns.length;t++){var n=this.columns[t];e+=n.name+" "+n.type,"id"==n.name&&(e+=" primary key"),(t+1!=this.columns.length||this.fkCount>0)&&(e+=", ")}var r=0;if(this.fkCount>0)for(var t=0;t<this.columns.length;t++){var n=this.columns[t];if(""!==n.fk){if(r++,e+="FOREIGN KEY("+n.name+") REFERENCES "+n.fk,r==this.fkCount)break;e+=", "}}e+=");";for(var t=0;t<this.regularIndexes.length;t++){var s=this.regularIndexes[t];e+=this.indexSQL(s,!1)}for(var t=0;t<this.uniqueIndexes.length;t++){var s=this.uniqueIndexes[t];e+=this.indexSQL(s,!0)}return e},indexSQL:function(e,t){var n="CREATE "+(t?"UNIQUE ":"")+"INDEX IF NOT EXISTS ";n+=e.name,n+=" ON ",n+=this.name;for(var r=[],s=0;s<e.columns.length;s++)r.push(e.columns[s].name);return n+=" ("+r.join(", ")+");"},insertSQL:function(){for(var e="",t=0;t<this.rows.length;t++){var n=this.rows[t],r="";e+="INSERT INTO "+this.name+"(";for(var s=0;s<this.columns.length;s++){var i=this.columns[s];e+=i.name,r+="text"==i.type.toLowerCase()?"'"+escape(n.cells[s])+"'":escape(n.cells[s]),s+1!=this.columns.length&&(e+=", ",r+=", ")}e+=") VALUES ("+r+");"}return e},getRegularIndex:function(e){return this.getIndex(this.regularIndexes,e)},getUniqueIndex:function(e){return this.getIndex(this.uniqueIndexes,e)},getIndex:function(e,t){for(var n=0;e>n;n++){var r=e[n];if(r.name==t)return r}return null}},s=0;s<t.feed.entry.length;s++){var i=t.feed.entry[s];if("1"==i.gs$cell.row){var o=parseInt(i.gs$cell.col,10)-1,a=i.gs$cell.$t,l=a.substring(0,a.indexOf("(")).trim(),u=a.substring(a.indexOf("(")+1,a.indexOf(")")).trim(),h={pos:o,name:l,type:u,fk:""};n.push(h)}else{if("2"!=i.gs$cell.row)break;var o=parseInt(i.gs$cell.col,10)-1,h=n[o],a=i.gs$cell.$t;if(""!=a)for(var c=a.split(","),f=0;f<c.length;f++){var d=c[f].trim();if(d.toLowerCase().indexOf("fk_")>=0)r.fkCount++,h.fk=d.substring(3,d.length);else if(d.toLowerCase().indexOf("in_")>=0){var p=r.getRegularIndex(d.toLowerCase());null==p&&(p={name:d.toLowerCase(),columns:[]},r.regularIndexes.push(p)),p.columns.push(h)}else if(d.toLowerCase().indexOf("un_")>=0){var g=r.getUniqueIndex(d.toLowerCase());null==g&&(g={name:d.toLowerCase(),columns:[]},r.uniqueIndexes.push(g)),g.columns.push(h)}}}}return r.columns=n,r},Sheets2sqlite.prototype.insertData=function(e,t){for(var n=[],r=3,s=0;s<t.feed.entry.length;s++){var i=t.feed.entry[s],o=parseInt(i.gs$cell.col,10)-1,a=parseInt(i.gs$cell.row,10)-r;if(!(0>a)){0==o&&n.push({row:a,cells:[]});var l=n[a];l.cells.push(i.gs$cell.$t)}}e.rows=n},Sheets2sqlite.prototype.loadData=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.db.exec(n.createSQL()),this.db.exec(n.insertSQL())}};var escape=function(e){var t=e.replace("'","''");return t=t.replace('"','""')},tableCreate=function(){function e(e,t){if(0===e.length)return"";var n="<"+t+">",r="</"+t+">";return n+e.join(r+n)+r}return function(t,n){var r=document.createElement("table"),s="<thead>"+e(t,"th")+"</thead>",i=n.map(function(t){return e(t,"td")});return s+="<tbody>"+e(i,"tr")+"</tbody>",r.innerHTML=s,r}};