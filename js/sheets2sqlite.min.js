var Sheets2sqlite=function(e,t,n){this.db=e;this.tablesToProcess=n;this.tables=[];this.control={reqs:0,reqOk:false,resps:0,ok:function(){return this.reqOk&&this.reqs==this.resps},reset:function(){this.reqs=0;this.resps=0;this.reqOk=false}};this.url="//spreadsheets.google.com/feeds/worksheets/"+t+"/public/values?alt=json"};Sheets2sqlite.prototype.start=function(e){this.done=e;var t=this;$.ajax({url:this.url}).done(function(e){for(var n=0;n<e.feed.entry.length;n++){var r=e.feed.entry[n];var i={name:r.title.$t,link:r.link[1].href.replace("https:","")+"?alt=json"};t.control.reqs++;(function(e,n){$.ajax({url:n}).done(function(n){t.processWorksheetData(e,n)})})(i.name,i.link)}t.control.reqOk=true})};Sheets2sqlite.prototype.processWorksheetData=function(e,t){this.control.resps++;if($.inArray(e,this.tablesToProcess)>=0){var n=this.createTable(e,t);this.insertData(n,t);this.tables.push(n)}if(this.control.ok()){this.loadData(this.tables,this.done);this.control.reset()}};Sheets2sqlite.prototype.createTable=function(e,t){var n=[];var r={name:e,fkCount:false,validColumns:[],regularIndexes:[],uniqueIndexes:[],createSQL:function(){var e="CREATE TABLE "+this.name+" (";for(var t=0;t<this.columns.length;t++){var n=this.columns[t];e+=n.name+" "+n.type;if(n.name=="id")e+=" primary key";if(t+1!=this.columns.length||this.fkCount>0){e+=", "}}var r=0;if(this.fkCount>0){for(var t=0;t<this.columns.length;t++){var n=this.columns[t];if(n.fk!==""){r++;e+="FOREIGN KEY("+n.name+") REFERENCES "+n.fk;if(r!=this.fkCount){e+=", "}else{break}}}}e+=");";for(var t=0;t<this.regularIndexes.length;t++){var i=this.regularIndexes[t];e+=this.indexSQL(i,false)}for(var t=0;t<this.uniqueIndexes.length;t++){var i=this.uniqueIndexes[t];e+=this.indexSQL(i,true)}return e},indexSQL:function(e,t){var n="CREATE "+(t?"UNIQUE ":"")+"INDEX IF NOT EXISTS ";n+=e.name;n+=" ON ";n+=this.name;var r=[];for(var i=0;i<e.columns.length;i++){r.push(e.columns[i].name)}n+=" ("+r.join(", ")+");";return n},insertSQL:function(){var e="";for(var t=0;t<this.rows.length;t++){var n=this.rows[t];var r="";e+="INSERT INTO "+this.name+"(";for(var i=0;i<this.columns.length;i++){var s=this.columns[i];e+=s.name;var o=escape(n.cells[i]);if(o===""){r+="NULL"}else if(s.type.toLowerCase()=="text"){r+="'"+o+"'"}else{r+=o}if(i+1!=this.columns.length){e+=", ";r+=", "}}e+=") VALUES ("+r+");"}return e},getRegularIndex:function(e){return this.getIndex(this.regularIndexes,e)},getUniqueIndex:function(e){return this.getIndex(this.uniqueIndexes,e)},getIndex:function(e,t){for(var n=0;n<e;n++){var r=e[n];if(r.name==t){return r}}return null}};for(var i=0;i<t.feed.entry.length;i++){var s=t.feed.entry[i];if(s.gs$cell.row=="1"){var o=parseInt(s.gs$cell.col,10)-1;var u=s.gs$cell.$t;var a=u.substring(0,u.indexOf("(")).trim();var f=u.substring(u.indexOf("(")+1,u.indexOf(")")).trim();var l={pos:o,name:a,type:f,fk:""};n.push(l);r.validColumns.push(o)}else if(s.gs$cell.row=="2"){var o=parseInt(s.gs$cell.col,10)-1;var l=n[r.validColumns.indexOf(o)];var u=s.gs$cell.$t;if(u!==""){var c=u.split(",");for(var h=0;h<c.length;h++){var p=c[h].trim();if(p.toLowerCase().indexOf("fk")===0){r.fkCount++;l.fk=p.substring(p.indexOf("(")+1,p.indexOf(")")).replace(".","(")+")"}else if(p.toLowerCase().indexOf("in_")>=0){var d=r.getRegularIndex(p.toLowerCase());if(d===null){d={name:p.toLowerCase(),columns:[]};r.regularIndexes.push(d)}d.columns.push(l)}else if(p.toLowerCase().indexOf("un_")>=0){var v=r.getUniqueIndex(p.toLowerCase());if(v===null){v={name:p.toLowerCase(),columns:[]};r.uniqueIndexes.push(v)}v.columns.push(l)}}}}else{break}}r.columns=n;return r};Sheets2sqlite.prototype.insertData=function(e,t){var n=[];var r=3;for(var i=0;i<t.feed.entry.length;i++){var s=t.feed.entry[i];var o=parseInt(s.gs$cell.col,10)-1;var u=parseInt(s.gs$cell.row,10)-r;if(u<0){continue}if(o===0){n.push({row:u,cells:[]})}if(e.validColumns.indexOf(o)>=0){var a=n[u];while(a.cells.length<e.validColumns.indexOf(o)){a.cells.push("")}a.cells.push(s.gs$cell.$t)}}e.rows=n};Sheets2sqlite.prototype.loadData=function(e,t){for(var n=0;n<e.length;n++){var r=e[n];console.log("createSQL:",r.createSQL());this.db.exec(r.createSQL());var i=r.insertSQL().split(";");for(var s=0;s<i.length;s++){var o=i[s].trim();if(o!==""){console.log("insert:",o);this.db.exec(o)}}}if(typeof t=="function"){t()}};var escape=function(e){if(e===""||typeof e=="undefined"){return""}var t=e.replace(/'/g,"''");t=t.replace('"','""');return t};var tableCreate=function(){function e(e,t){if(e.length===0)return"";var n="<"+t+">",r="</"+t+">";return n+e.join(r+n)+r}return function(t,n){var r=document.createElement("table");var i="<thead>"+e(t,"th")+"</thead>";var s=n.map(function(t){return e(t,"td")});i+="<tbody>"+e(s,"tr")+"</tbody>";r.innerHTML=i;return r}}